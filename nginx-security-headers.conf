# Cabeçalhos de Segurança HTTP para Nginx
# Adicione estas linhas no bloco server {} do seu arquivo de configuração do Nginx

# Content Security Policy (CSP) - Proteção contra XSS
add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self'; frame-src 'self'; object-src 'none'; base-uri 'self'; form-action 'self';" always;

# X-Frame-Options - Proteção contra Clickjacking
add_header X-Frame-Options "SAMEORIGIN" always;

# X-Content-Type-Options - Previne MIME sniffing
add_header X-Content-Type-Options "nosniff" always;

# X-XSS-Protection - Proteção contra XSS (para navegadores legados)
add_header X-XSS-Protection "1; mode=block" always;

# Referrer Policy - Controla informações de referência
add_header Referrer-Policy "strict-origin-when-cross-origin" always;

# HTTP Strict Transport Security (HSTS) - Força HTTPS
# Ativado para tacontudo.com com certificado SSL/TLS
add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;

# Permissions Policy - Controla APIs do navegador
add_header Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=(), usb=(), magnetometer=(), gyroscope=(), speaker=()" always;

# Cross-Origin Resource Policy - Proteção contra inclusão cross-origin
add_header Cross-Origin-Resource-Policy "same-origin" always;

# Cross-Origin Opener Policy - Proteção contra ataques cross-origin
add_header Cross-Origin-Opener-Policy "same-origin" always;

# Remove informações do servidor
server_tokens off;
more_set_headers "Server: nginx";

# ========================================
# PROTEÇÃO CONTRA ATAQUES E LIMITAÇÃO DE IP
# ========================================

# Rate Limiting - Limita requisições por IP
# Define zona de memória para controle de rate limiting
limit_req_zone $binary_remote_addr zone=general:10m rate=10r/s;
limit_req_zone $binary_remote_addr zone=login:10m rate=1r/s;
limit_req_zone $binary_remote_addr zone=api:10m rate=5r/s;

# Connection Limiting - Limita conexões simultâneas por IP
limit_conn_zone $binary_remote_addr zone=conn_limit_per_ip:10m;

# Proteção contra User-Agents maliciosos
map $http_user_agent $blocked_agent {
    default 0;
    ~*malicious 1;
    ~*bot 1;
    ~*crawler 1;
    ~*scanner 1;
    ~*nikto 1;
    ~*sqlmap 1;
    "" 1;
}

# Bloqueio de IPs suspeitos (adicione IPs conforme necessário)
# Exemplo: geo $blocked_ip {
#     default 0;
#     192.168.1.100 1;
#     10.0.0.50 1;
# }

# Proteção contra ataques de força bruta
map $request_uri $is_login {
    default 0;
    ~*/login 1;
    ~*/admin 1;
    ~*/wp-admin 1;
    ~*/contact 1;
}

# ========================================
# EXEMPLO DE CONFIGURAÇÃO COMPLETA COM PROTEÇÕES
# ========================================

# Exemplo de configuração para tacontudo.com:
# server {
#     listen 80;
#     server_name tacontudo.com www.tacontudo.com;
#     return 301 https://$server_name$request_uri;
# }
#
# server {
#     listen 443 ssl http2;
#     server_name tacontudo.com www.tacontudo.com;
#     
#     ssl_certificate /path/to/certificate.crt;
#     ssl_certificate_key /path/to/private.key;
#     
#     # Bloquear User-Agents maliciosos
#     if ($blocked_agent) {
#         return 403;
#     }
#     
#     # Aplicar rate limiting geral
#     limit_req zone=general burst=20 nodelay;
#     limit_conn conn_limit_per_ip 10;
#     
#     # Inclua os cabeçalhos de segurança acima aqui
#     
#     # Proteção especial para formulários de contato
#     location ~* /(contact|contato) {
#         limit_req zone=login burst=3 nodelay;
#         limit_conn conn_limit_per_ip 2;
#         
#         # Bloquear métodos HTTP desnecessários
#         if ($request_method !~ ^(GET|POST|HEAD)$) {
#             return 405;
#         }
#         
#         root /var/www/tacontudo;
#         index index.html;
#         try_files $uri $uri/ =404;
#     }
#     
#     # Proteção para arquivos administrativos
#     location ~* \.(htaccess|htpasswd|ini|log|sh|sql|conf)$ {
#         deny all;
#     }
#     
#     # Bloquear acesso a arquivos ocultos
#     location ~ /\. {
#         deny all;
#     }
#     
#     location / {
#         # Rate limiting mais permissivo para páginas normais
#         limit_req zone=general burst=50 nodelay;
#         limit_conn conn_limit_per_ip 15;
#         
#         root /var/www/tacontudo;
#         index index.html;
#         try_files $uri $uri/ =404;
#         
#         # Adicionar cache para recursos estáticos
#         location ~* \.(jpg|jpeg|png|gif|ico|css|js|woff|woff2|ttf|svg)$ {
#             expires 1y;
#             add_header Cache-Control "public, immutable";
#         }
#     }
# }
#
# ========================================
# CONFIGURAÇÕES ADICIONAIS DE SEGURANÇA
# ========================================
#
# Para ativar o bloqueio de IPs específicos, descomente e configure:
# geo $blocked_ip {
#     default 0;
#     # Adicione IPs maliciosos aqui:
#     # 192.168.1.100 1;
#     # 10.0.0.50 1;
# }
#
# E adicione no bloco server:
# if ($blocked_ip) {
#     return 403;
# }
#
# MONITORAMENTO:
# Para monitorar ataques, adicione logs específicos:
# access_log /var/log/nginx/tacontudo_access.log;
# error_log /var/log/nginx/tacontudo_error.log warn;
#
# COMANDOS ÚTEIS PARA MONITORAMENTO:
# tail -f /var/log/nginx/tacontudo_error.log | grep "limiting"
# grep "403" /var/log/nginx/tacontudo_access.log | tail -20